# 微信小程序自动跳转功能说明（移动端专用）

## 🎯 功能概述

网站首页会自动检测访问环境，并智能决定是否跳转到微信小程序：

- ✅ **桌面端（PC）**：正常显示网页内容，不跳转
- ✅ **移动端 + 在微信小程序 webview 中**：正常显示网页内容，不跳转
- ✅ **移动端 + 其他环境**（浏览器、微信内置浏览器等）：自动跳转到微信小程序

## 📋 跳转决策流程

```
页面加载
  ↓
检测设备类型
  ↓
├─ 桌面端？
│  └─ 是 → 正常显示网页 ✅
│
└─ 否（移动端）
   ↓
   检测是否在微信小程序 webview 中
   ↓
   ├─ 是 → 正常显示网页 ✅
   │
   └─ 否 → 显示跳转提示 → 获取链接 → 自动跳转到小程序 🚀
```

## 🔍 检测机制

### 1. 设备类型检测

使用 `useIsMobile()` hook 检测是否为移动端：
- 检测屏幕宽度
- 检测 User Agent
- 检测触摸能力

### 2. 微信小程序环境检测

使用多重检测方法（位于 `src/lib/wx-env-detect.ts`）：
- `window.__wxjs_environment`
- `window.wx.miniProgram`
- User Agent 字符串
- 异步 `wx.miniProgram.getEnv()`

## 📱 不同场景的行为

### 场景 1: 桌面端浏览器访问
```
Chrome/Firefox/Safari (PC) → 正常显示网页 ✅
```
**用户体验**：完整的网页内容，所有功能正常使用

### 场景 2: 移动端浏览器访问
```
Safari (iOS) / Chrome (Android) → 显示跳转提示 → 跳转到微信小程序 🚀
```
**用户体验**：看到跳转页面，自动打开微信小程序

### 场景 3: 微信内置浏览器访问（移动端）
```
微信中点击链接 → 显示跳转提示 → 跳转到微信小程序 🚀
```
**用户体验**：从微信直接跳转到小程序

### 场景 4: 微信小程序 webview 访问（移动端）
```
小程序 <web-view> → 正常显示网页 ✅
```
**用户体验**：在小程序中正常浏览网页

## 🎨 跳转提示页面

移动端用户在非小程序环境下会看到：

```
┌─────────────────────────────────┐
│   [🔄 旋转动画]                  │
│                                  │
│  正在跳转到微信小程序...          │
│  请稍候，即将为您打开小橙有门      │
│  如未自动跳转，请确保已安装微信    │
│                                  │
│  [取消跳转，继续浏览网页]         │
└─────────────────────────────────┘
```

## ⚙️ 配置说明

### 修改跳转参数

编辑 `src/pages/home.tsx`，在 `useEffect` 中找到：

```typescript
const urlLink = await fetchWxUrlLink({
  path: '/pages/index/index',    // 小程序落地页
  expire_type: 1,                 // 过期类型
  expire_interval: 30,            // 过期天数
  env_version: 'release',         // 版本
});
```

### 修改移动端判断逻辑

如果需要调整移动端的判断标准，编辑 `src/hooks/use-mobile.tsx`。

### 禁用自动跳转

**临时禁用**：在 `src/pages/home.tsx` 中：

```typescript
useEffect(() => {
  const checkAndRedirect = async () => {
    return; // 添加这行直接返回，禁用跳转
    
    // ... 原有代码
  };
  checkAndRedirect();
}, [isMobile]);
```

**条件禁用**：添加环境变量控制：

```typescript
const ENABLE_AUTO_REDIRECT = process.env.NODE_ENV === 'production';

useEffect(() => {
  if (!ENABLE_AUTO_REDIRECT) return;
  
  const checkAndRedirect = async () => {
    // ... 跳转逻辑
  };
  checkAndRedirect();
}, [isMobile]);
```

## 🧪 测试方法

### 测试 1: 桌面端浏览器 ✅
```bash
# 在 Chrome/Firefox/Safari (PC) 中访问
http://localhost:8989
```
**预期结果**：正常显示网页，不跳转

**控制台输出**：
```
"当前是桌面端，无需跳转"
```

### 测试 2: 移动端浏览器 🚀
```bash
# 使用 Chrome DevTools 切换到移动设备模式
# 或在真实移动设备上访问
http://localhost:8989
```
**预期结果**：显示跳转提示页面 → 跳转到微信小程序

**控制台输出**：
```
"当前是移动端且不在微信小程序中，准备跳转..."
"获取到微信小程序链接，即将跳转: https://wxaurl.cn/..."
```

### 测试 3: 微信内置浏览器（移动端）🚀
1. 在微信中分享网站链接
2. 点击链接打开

**预期结果**：显示跳转提示 → 跳转到微信小程序

### 测试 4: 微信小程序 webview ✅
在小程序中使用 `<web-view>` 加载：
```xml
<web-view src="https://your-domain.com"></web-view>
```

**预期结果**：正常显示网页，不跳转

**控制台输出**：
```
"当前在微信小程序 webview 中，无需跳转"
```

### 测试 5: 取消跳转功能
1. 在移动端浏览器打开网站
2. 看到跳转提示页面
3. 点击"取消跳转，继续浏览网页"

**预期结果**：回到正常的网站首页

## 📊 行为对比表

| 访问方式 | 设备类型 | 是否跳转 | 用户体验 |
|---------|---------|---------|---------|
| Chrome/Firefox/Safari | 桌面端 | ❌ 不跳转 | 正常浏览网页 |
| Safari (iOS) | 移动端 | ✅ 跳转 | 自动打开小程序 |
| Chrome (Android) | 移动端 | ✅ 跳转 | 自动打开小程序 |
| 微信内置浏览器 | 桌面端 | ❌ 不跳转 | 正常浏览网页 |
| 微信内置浏览器 | 移动端 | ✅ 跳转 | 自动打开小程序 |
| 小程序 webview | 移动端 | ❌ 不跳转 | 正常浏览网页 |

## 🔧 调试信息

打开浏览器控制台查看调试信息：

```javascript
// 桌面端
"当前是桌面端，无需跳转"

// 移动端 - 在小程序中
"当前在微信小程序 webview 中，无需跳转"

// 移动端 - 不在小程序中
"当前是移动端且不在微信小程序中，准备跳转..."
"获取到微信小程序链接，即将跳转: https://wxaurl.cn/..."

// 错误情况
"获取微信小程序链接失败"
"自动跳转失败: [错误信息]"
```

## ❓ 故障排查

### 问题 1: 桌面端也触发了跳转

**可能原因**：
- `useIsMobile()` 判断错误
- 浏览器窗口太小

**解决方法**：
1. 检查浏览器窗口大小
2. 打开控制台查看 `isMobile` 的值
3. 检查 `src/hooks/use-mobile.tsx` 的逻辑

### 问题 2: 移动端不跳转

**可能原因**：
- `useIsMobile()` 返回 false
- API 请求失败

**解决方法**：
1. 打开控制台查看调试信息
2. 检查网络请求是否成功
3. 验证代理配置

### 问题 3: 在微信小程序中也跳转了

**可能原因**：
- 环境检测失败
- 微信版本过旧
- 小程序未正确加载 JSSDK

**解决方法**：
1. 更新微信到最新版本
2. 检查小程序是否正确配置了业务域名
3. 确保小程序引入了微信 JSSDK

## 📚 相关文件

- `src/pages/home.tsx` - 主页及跳转逻辑
- `src/lib/wx-env-detect.ts` - 微信环境检测
- `src/lib/wx-api-config.ts` - API 配置
- `src/hooks/use-mobile.tsx` - 移动端检测 hook
- `rsbuild.config.ts` - 代理配置

## 💡 最佳实践

### 1. 用户体验优化
- ✅ 桌面端不跳转，保留完整功能
- ✅ 移动端自动跳转，引导用户使用小程序
- ✅ 提供取消按钮，给用户选择权

### 2. SEO 优化
由于桌面端不跳转，搜索引擎爬虫可以正常索引网站内容

### 3. 性能优化
- 环境检测快速完成（< 1秒）
- 跳转提示页面轻量级
- 失败自动降级到正常显示

## ⚠️ 注意事项

1. **开发环境测试**：使用 Chrome DevTools 的设备模拟器测试移动端
2. **真机测试**：务必在真实移动设备上测试跳转流程
3. **微信版本**：确保测试时使用较新版本的微信
4. **链接过期**：注意 `expire_interval` 设置，避免链接过期
5. **用户提示**：跳转失败时给予明确提示

## 🔄 版本历史

- v2.0 - 添加桌面端/移动端区分
  - ✅ 桌面端不跳转
  - ✅ 移动端自动跳转
  - ✅ 保留取消功能
  
- v1.0 - 基础自动跳转功能
  - 环境检测
  - 自动跳转
  - 跳转提示页面


